import { describe, it, expect, beforeAll } from 'vitest';
import {
  calculateAlcoholUnits,
  calculateCurrentBloodAlcohol,
  estimateBloodAlcoholContent,
  estimateAdvancedBloodAlcoholContent,
  calculateAdvancedCurrentBloodAlcohol,
} from '../utils/calculations';
import { DrinkRecord } from '../types';

describe('Calculs d\'alcool - Tests avec personne fictive', () => {
  // üë§ PERSONNE FICTIVE : Marie, 28 ans
  const marie = {
    age: 28,
    gender: 'female' as const,
    height: 165, // cm
    weight: 60, // kg
    activityLevel: 'moderate' as const,
  };

  // üç∫ SCENARIO DE TEST : Soir√©e de Marie
  // 20h00 : 1 bi√®re (50cl, 5%)
  // 21h00 : 1 verre de vin (12.5cl, 12%) 
  // 22h00 : 1 shot (4cl, 40%)
  // 23h00 : 1 bi√®re (50cl, 5%)
  // Test effectu√© √† 23h30 (30min apr√®s la derni√®re boisson)

  const now = new Date('2025-01-28T23:30:00Z');
  const drinks: DrinkRecord[] = [
    {
      id: '1',
      groupId: 'test',
      userId: 'marie',
      userName: 'Marie',
      userAvatar: '',
      category: 'beer',
      drinkType: 'Bi√®re blonde',
      volume: 50,
      alcoholDegree: 5,
      alcoholContent: 5,
      alcoholUnits: 0, // Sera calcul√©
      timestamp: new Date('2025-01-28T20:00:00Z'), // Il y a 3h30
      createdAt: new Date('2025-01-28T20:00:00Z'),
      syncStatus: 'synced',
      lastModified: new Date('2025-01-28T20:00:00Z'),
    },
    {
      id: '2',
      groupId: 'test',
      userId: 'marie',
      userName: 'Marie',
      userAvatar: '',
      category: 'wine',
      drinkType: 'Vin rouge',
      volume: 12.5,
      alcoholDegree: 12,
      alcoholContent: 12,
      alcoholUnits: 0, // Sera calcul√©
      timestamp: new Date('2025-01-28T21:00:00Z'), // Il y a 2h30
      createdAt: new Date('2025-01-28T21:00:00Z'),
      syncStatus: 'synced',
      lastModified: new Date('2025-01-28T21:00:00Z'),
    },
    {
      id: '3',
      groupId: 'test',
      userId: 'marie',
      userName: 'Marie',
      userAvatar: '',
      category: 'shot',
      drinkType: 'Vodka',
      volume: 4,
      alcoholDegree: 40,
      alcoholContent: 40,
      alcoholUnits: 0, // Sera calcul√©
      timestamp: new Date('2025-01-28T22:00:00Z'), // Il y a 1h30
      createdAt: new Date('2025-01-28T22:00:00Z'),
      syncStatus: 'synced',
      lastModified: new Date('2025-01-28T22:00:00Z'),
    },
    {
      id: '4',
      groupId: 'test',
      userId: 'marie',
      userName: 'Marie',
      userAvatar: '',
      category: 'beer',
      drinkType: 'Bi√®re blonde',
      volume: 50,
      alcoholDegree: 5,
      alcoholContent: 5,
      alcoholUnits: 0, // Sera calcul√©
      timestamp: new Date('2025-01-28T23:00:00Z'), // Il y a 30min
      createdAt: new Date('2025-01-28T23:00:00Z'),
      syncStatus: 'synced',
      lastModified: new Date('2025-01-28T23:00:00Z'),
    },
  ];

  beforeAll(() => {
    // Calculer les unit√©s d'alcool pour chaque boisson
    drinks.forEach(drink => {
      drink.alcoholUnits = calculateAlcoholUnits(drink.volume, drink.alcoholDegree);
    });
  });

  describe('üìä Test 1 : Calcul des unit√©s d\'alcool individuelles', () => {
    it('devrait calculer correctement les unit√©s pour une bi√®re (50cl, 5%)', () => {
      const units = calculateAlcoholUnits(50, 5);
      
      // üßÆ CALCUL ATTENDU :
      // Volume d'alcool pur = 50cl √ó 5% = 2.5cl = 25ml
      // Poids d'alcool = 25ml √ó 0.8 (densit√©) = 20g
      // Unit√©s = 20g √∑ 10g/unit√© = 2.0 unit√©s
      
      expect(units).toBe(2.0);
      console.log(`üç∫ Bi√®re 50cl/5% : ${units} unit√©s (attendu: 2.0)`);
    });

    it('devrait calculer correctement les unit√©s pour un verre de vin (12.5cl, 12%)', () => {
      const units = calculateAlcoholUnits(12.5, 12);
      
      // üßÆ CALCUL ATTENDU :
      // Volume d'alcool pur = 12.5cl √ó 12% = 1.5cl = 15ml
      // Poids d'alcool = 15ml √ó 0.8 = 12g
      // Unit√©s = 12g √∑ 10g/unit√© = 1.2 unit√©s
      
      expect(units).toBe(1.2);
      console.log(`üç∑ Vin 12.5cl/12% : ${units} unit√©s (attendu: 1.2)`);
    });

    it('devrait calculer correctement les unit√©s pour un shot (4cl, 40%)', () => {
      const units = calculateAlcoholUnits(4, 40);
      
      // üßÆ CALCUL ATTENDU :
      // Volume d'alcool pur = 4cl √ó 40% = 1.6cl = 16ml
      // Poids d'alcool = 16ml √ó 0.8 = 12.8g
      // Unit√©s = 12.8g √∑ 10g/unit√© = 1.28 ‚âà 1.3 unit√©s
      
      expect(units).toBeCloseTo(1.28, 1);
      console.log(`ü•É Shot 4cl/40% : ${units} unit√©s (attendu: ~1.3)`);
    });
  });

  describe('üìà Test 2 : Consommation totale de Marie', () => {
    it('devrait calculer le total des unit√©s consomm√©es', () => {
      const totalUnits = drinks.reduce((sum, drink) => sum + drink.alcoholUnits, 0);
      
      // üßÆ TOTAL ATTENDU :
      // Bi√®re 1 : 2.0 unit√©s
      // Vin : 1.2 unit√©s  
      // Shot : 1.28 unit√©s
      // Bi√®re 2 : 2.0 unit√©s
      // TOTAL = 6.48 unit√©s (pas 15.5 !)
      
      expect(totalUnits).toBeCloseTo(6.48, 1);
      console.log(`üìä Total unit√©s consomm√©es : ${totalUnits} (attendu: ~6.5)`);
    });
  });

  describe('‚è∞ Test 3 : Unit√©s actuelles avec √©limination', () => {
    it('devrait calculer les unit√©s restantes apr√®s √©limination (calcul simple)', () => {
      // Mock de la date actuelle pour les tests
      const originalDate = Date;
      global.Date = class extends Date {
        constructor(...args: any[]) {
          if (args.length === 0) {
            super(now);
          } else {
            super(...args);
          }
        }
        static now() {
          return now.getTime();
        }
      } as any;

      const currentUnits = calculateCurrentBloodAlcohol(drinks);
      
      // üßÆ CALCUL ATTENDU avec √©limination √† 0.12 unit√©/heure :
      // Bi√®re 1 (3h30 ago) : 2.0 - (3.5 √ó 0.12) = 2.0 - 0.42 = 1.58 unit√©s
      // Vin (2h30 ago) : 1.2 - (2.5 √ó 0.12) = 1.2 - 0.30 = 0.90 unit√©s  
      // Shot (1h30 ago) : 1.28 - (1.5 √ó 0.12) = 1.28 - 0.18 = 1.10 unit√©s
      // Bi√®re 2 (30min ago) : 2.0 - (0.5 √ó 0.12) = 2.0 - 0.06 = 1.94 unit√©s
      // TOTAL ‚âà 5.52 unit√©s
      
      expect(currentUnits).toBeGreaterThan(5.0);
      expect(currentUnits).toBeLessThan(6.5);
      console.log(`‚è∞ Unit√©s actuelles (avec √©limination) : ${currentUnits} (attendu: ~5.5)`);
      
      // Restaurer Date
      global.Date = originalDate;
    });
  });

  describe('ü©∏ Test 4 : Alcool√©mie dans le sang', () => {
    it('devrait calculer l\'alcool√©mie avec la formule simple', () => {
      const currentUnits = 5.5; // Approximation du test pr√©c√©dent
      const { bloodAlcohol, breathAlcohol } = estimateBloodAlcoholContent(
        currentUnits, 
        marie.weight, 
        marie.gender === 'female'
      );
      
      // üßÆ CALCUL ATTENDU (formule Widmark) :
      // Alcool en grammes = 5.5 √ó 10g = 55g
      // Coefficient femme = 0.6
      // Alcool√©mie = 55g √∑ (60kg √ó 0.6) = 55 √∑ 36 = 1.53 g/L
      // Air expir√© = 1.53 √ó 0.5 = 0.76 mg/L
      
      expect(bloodAlcohol).toBeGreaterThan(1.2);
      expect(bloodAlcohol).toBeLessThan(1.6);
      expect(breathAlcohol).toBeCloseTo(bloodAlcohol * 0.5, 1);
      console.log(`ü©∏ Alcool√©mie sang : ${bloodAlcohol} g/L (attendu: ~1.5)`);
      console.log(`üí® Alcool√©mie air : ${breathAlcohol} mg/L (attendu: ~0.8)`);
    });
  });

  describe('üî¨ Test 5 : Calculs avanc√©s (profil complet)', () => {
    it('devrait utiliser le profil personnalis√© de Marie', () => {
      const currentUnits = 5.5;
      const advancedCalcs = estimateAdvancedBloodAlcoholContent(currentUnits, marie);
      
      console.log(`üî¨ Calculs avanc√©s pour Marie :`, {
        alcool√©mie: `${advancedCalcs.bloodAlcohol} g/L`,
        airExpir√©: `${advancedCalcs.breathAlcohol} mg/L`,
        √©limination: `${advancedCalcs.eliminationRate} unit√©s/h`,
        tempsSobri√©t√©: `${advancedCalcs.timeToSober} heures`,
        coeffWidmark: advancedCalcs.widmarkFactor,
        IMC: advancedCalcs.metabolismInfo.bmi,
      });
      
      // Tests de coh√©rence
      expect(advancedCalcs.bloodAlcohol).toBeGreaterThan(0);
      expect(advancedCalcs.bloodAlcohol).toBeLessThan(3.0); // Seuil de coh√©rence
      expect(advancedCalcs.breathAlcohol).toBeCloseTo(advancedCalcs.bloodAlcohol * 0.5, 1);
      expect(advancedCalcs.timeToSober).toBeGreaterThan(3.0); // Au moins 3h
      expect(advancedCalcs.timeToSober).toBeLessThan(50.0); // Temps r√©aliste pour 5.5 unit√©s
    });
  });

  describe('‚ùå Test 6 : V√©rification des valeurs aberrantes actuelles', () => {
    it('devrait d√©tecter si les calculs actuels donnent des r√©sultats aberrants', () => {
      // Ce test documente les probl√®mes actuels
      const problematicUnits = 15.5; // Valeur actuelle bug
      const problematicTime = 62.4; // Temps actuel bug
      
      console.log(`‚ùå PROBL√àMES D√âTECT√âS :`);
      console.log(`   - Unit√©s calcul√©es: ${problematicUnits} (devrait √™tre ~6.5)`);
      console.log(`   - Temps √©limination: ${problematicTime}h (devrait √™tre ~37h max)`);
      
      // Tests pour documenter le probl√®me
      expect(problematicUnits).toBeGreaterThan(10); // Bug confirm√©
      expect(problematicTime).toBeGreaterThan(50); // Bug confirm√©
      
      // Les valeurs correctes devraient √™tre :
      const expectedUnits = 6.5;
      const expectedTime = expectedUnits / 0.15; // ~43h max
      
      console.log(`‚úÖ VALEURS ATTENDUES :`);
      console.log(`   - Unit√©s totales: ~${expectedUnits}`);
      console.log(`   - Temps √©limination: ~${expectedTime.toFixed(1)}h`);
    });
  });

  describe('üéØ Test 7 : Validation avec r√©f√©rences officielles', () => {
    it('devrait respecter les r√©f√©rences officielles fran√ßaises', () => {
      // Source: S√©curit√© Routi√®re fran√ßaise
      // 1 verre standard = 10g d'alcool pur = 1 unit√©
      
      const referencedrinks = [
        { name: 'Bi√®re (25cl, 5%)', volume: 25, degree: 5, expectedUnits: 1.0 },
        { name: 'Vin (10cl, 12%)', volume: 10, degree: 12, expectedUnits: 0.96 },
        { name: 'Whisky (3cl, 40%)', volume: 3, degree: 40, expectedUnits: 0.96 },
        { name: 'Pastis (2.5cl, 45%)', volume: 2.5, degree: 45, expectedUnits: 0.9 },
      ];

      console.log(`üéØ VALIDATION R√âF√âRENCES OFFICIELLES :`);
      referencedrinks.forEach(drink => {
        const calculated = calculateAlcoholUnits(drink.volume, drink.degree);
        const difference = Math.abs(calculated - drink.expectedUnits);
        
        console.log(`   ${drink.name}: ${calculated} unit√©s (r√©f√©rence: ${drink.expectedUnits})`);
        expect(difference).toBeLessThan(0.1); // Tol√©rance de 0.1 unit√©
      });
    });
  });

  describe('üß™ Test 8 : Validation personas de test', () => {
    it('devrait utiliser les personas de test de TestHelper', () => {
      // Test d'int√©gration avec les nouveaux utilitaires
      const { marie, thomas, sophie, julien } = require('../utils/testHelper').PERSONAS;
      
      expect(marie.age).toBe(28);
      expect(thomas.gender).toBe('male');
      expect(sophie.weight).toBe(55);
      expect(julien.activityLevel).toBe('sedentary');
      
      console.log('‚úÖ Personas de test charg√©s:', { marie: marie.name, thomas: thomas.name, sophie: sophie.name, julien: julien.name });
    });
  });

  describe('üî¨ Test 9 : Calculs personnalis√©s avanc√©s avec personas', () => {
    it('devrait calculer diff√©remment pour chaque persona', () => {
      const { marie, thomas, sophie, julien } = require('../utils/testHelper').PERSONAS;
      const baseUnits = 3.0; // 3 unit√©s standard

      const personas = [marie, thomas, sophie, julien];
      const results: any[] = [];

      personas.forEach(persona => {
        const advancedCalcs = estimateAdvancedBloodAlcoholContent(baseUnits, persona);
        results.push({
          name: persona.name,
          bloodAlcohol: advancedCalcs.bloodAlcohol,
          eliminationRate: advancedCalcs.eliminationRate,
          timeToSober: advancedCalcs.timeToSober,
          widmarkFactor: advancedCalcs.widmarkFactor,
          bmi: advancedCalcs.metabolismInfo.bmi,
        });
      });

      console.log('üî¨ COMPARAISON PERSONAS (3 unit√©s):');
      results.forEach(result => {
        console.log(`   ${result.name}: ${result.bloodAlcohol}g/L, √©lim: ${result.eliminationRate}u/h, sobri√©t√©: ${result.timeToSober}h`);
      });

      // V√©rifications de coh√©rence
      expect(results).toHaveLength(4);
      results.forEach(result => {
        expect(result.bloodAlcohol).toBeGreaterThan(0);
        expect(result.bloodAlcohol).toBeLessThan(3.0);
        expect(result.eliminationRate).toBeGreaterThan(0.1);
        expect(result.eliminationRate).toBeLessThan(0.25);
      });

      // Les hommes devraient avoir des alcool√©mies plus faibles (plus d'eau corporelle)
      const marieResult = results.find(r => r.name === 'Marie');
      const thomasResult = results.find(r => r.name === 'Thomas');
      expect(marieResult!.bloodAlcohol).toBeGreaterThan(thomasResult!.bloodAlcohol);
    });
  });
});